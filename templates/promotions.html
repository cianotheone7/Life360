{% extends "base.html" %}
{% block content %}
<div class="promo-container">
  <div class="promo-header">
    <div>
      <h1>Gifts & Banners</h1>
      <p class="muted">Track promotional kits, banners, gazebos and other marketing assets.</p>
    </div>
    <div class="promo-stats">
      <div class="stat-card">
        <div class="stat-label">Total Units</div>
        <div class="stat-value">{{ total_items or 0 }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Available</div>
        <div class="stat-value">{{ total_available or 0 }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Signed Out</div>
        <div class="stat-value">{{ total_signed_out or 0 }}</div>
      </div>
    </div>
  </div>

  <div class="promo-grid">
    <section class="promo-form card">
      <h2>Add Item</h2>
      <form method="post" action="{{ url_for('promotions_add') }}">
        <label>Name
          <input name="name" placeholder="e.g. Geneway Gift Box" required>
        </label>
        <label>Category
          <select name="category">
            <option value="Gift">Gift</option>
            <option value="Banner">Banner</option>
            <option value="Gazebo">Gazebo</option>
            <option value="Stand">Stand</option>
            <option value="Brochure">Brochure</option>
            <option value="Other">Other</option>
          </select>
        </label>
        <label>Description
          <textarea name="description" rows="2" placeholder="Optional details"></textarea>
        </label>
        <div class="split">
          <label>Quantity
            <input name="quantity" type="number" min="1" value="1" required>
          </label>
          <label>Purchase Date
            <input name="purchase_date" type="date">
          </label>
        </div>
        <div class="split">
          <label>Location
            <input name="location" placeholder="e.g. Sandton HQ">
          </label>
          <label>Condition
            <input name="condition" placeholder="New / Good / Fair">
          </label>
        </div>
        <label>Cost (optional)
          <input name="cost" type="number" step="0.01" placeholder="e.g. 1200">
        </label>
        <button class="btn" type="submit">Add Item</button>
      </form>
    </section>

    <section class="promo-list card">
      <h2>Inventory</h2>
      {% if not items %}
        <div class="empty-state">
          <p>No promotional items captured yet.</p>
        </div>
      {% else %}
        <div class="promo-table">
          {% for cat in categories %}
            {% set cat_items = items | selectattr('category', 'equalto', cat) | list %}
            {% if cat_items %}
              <div class="category-block">
                <div class="category-header">
                  <h3>{{ cat }}</h3>
                  <span>{{ cat_items|length }} item(s)</span>
                </div>
                {% for item in cat_items %}
                  <div class="item-row">
                    <div class="item-main">
                      <div class="item-title">
                        <strong>{{ item.name }}</strong>
                        {% if item.location %}
                          <span class="location-tag">{{ item.location }}</span>
                        {% endif %}
                      </div>
                      <div class="item-meta">
                        <span>Available: {{ item.display_available }}/{{ item.display_quantity }}</span>
                        <span>Signed out: {{ item.display_signed_out }}</span>
                        {% if item.signed_out and item.signed_out_by %}
                          <span class="status-tag signed-out">Last by {{ item.signed_out_by }}</span>
                        {% else %}
                          <span class="status-tag available">Ready</span>
                        {% endif %}
                        {% if item.expected_return_date %}
                          <span class="return-tag">Due {{ item.expected_return_date }}</span>
                        {% endif %}
                      </div>
                      {% if item.description %}
                        <p class="muted">{{ item.description }}</p>
                      {% endif %}
                      <div class="item-buttons">
                        <button type="button" class="btn secondary" onclick="togglePromoForm('{{ item.id }}','signout')">Sign Out</button>
                        <button type="button" class="btn" onclick="togglePromoForm('{{ item.id }}','return')">Return</button>
                        <form method="post" action="{{ url_for('promotions_delete', item_id=item.id) }}" class="inline-delete js-confirm-form" data-confirm="Delete {{ item.name }} and all tracking history?">
                          <button type="submit" class="btn danger">Delete</button>
                        </form>
                      </div>
                    </div>
                    <div class="item-actions">
                      <div id="promo-signout-{{ item.id }}" class="promo-action" hidden>
                        <form method="post" action="{{ url_for('promotions_sign_out', item_id=item.id) }}">
                          <div class="split">
                            <label>Qty
                              <input name="sign_out_qty" type="number" min="1" max="{{ item.display_available }}" value="{{ 1 if item.display_available else 0 }}" {% if item.display_available == 0 %}disabled{% endif %}>
                            </label>
                            <label>Return date
                              <input name="expected_return_date" type="date" {% if item.display_available == 0 %}disabled{% endif %}>
                            </label>
                          </div>
                          <label>Barcode
                            <input name="barcode" placeholder="Scan or type barcode" {% if item.display_available == 0 %}disabled{% endif %}>
                          </label>
                          <label>Signed out by
                            <input name="signed_out_by" placeholder="Staff member" {% if item.display_available == 0 %}disabled{% endif %}>
                          </label>
                          <label>Purpose
                            <input name="sign_out_notes" placeholder="Purpose / destination" {% if item.display_available == 0 %}disabled{% endif %}>
                          </label>
                          <button class="btn secondary" type="submit" {% if item.display_available == 0 %}disabled{% endif %}>Confirm Sign Out</button>
                        </form>
                      </div>
                      <div id="promo-return-{{ item.id }}" class="promo-action" hidden>
                        <form method="post" action="{{ url_for('promotions_return', item_id=item.id) }}">
                          <div class="split">
                            <label>Qty
                              <input name="return_qty" type="number" min="1" max="{{ item.display_signed_out or 1 }}" value="{{ 1 if item.display_signed_out else 0 }}">
                            </label>
                            <label>Returned by
                              <input name="returned_by" placeholder="Staff member" required>
                            </label>
                          </div>
                          <label>Notes
                            <input name="return_notes" placeholder="Condition / feedback">
                          </label>
                          <button class="btn" type="submit">Confirm Return</button>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </section>
  </div>

  <!-- Transaction History Section -->
  <section class="card history-section">
    <h2>Sign-Out & Return History</h2>
    {% set all_transactions = [] %}
    {% for item in items %}
      {% for txn in item.transactions %}
        {% set _ = all_transactions.append({'item_name': item.name, 'category': item.category, 'txn': txn}) %}
      {% endfor %}
    {% endfor %}
    
    {% if all_transactions|length > 0 %}
      {% set sorted_transactions = all_transactions|sort(attribute='txn.transaction_date', reverse=True) %}
      <div class="history-table">
        <div class="history-header">
          <div>Date/Time</div>
          <div>Item</div>
          <div>Type</div>
          <div>Qty</div>
          <div>Person</div>
          <div>Details</div>
        </div>
        {% for record in sorted_transactions[:50] %}
          <div class="history-row {% if record.txn.transaction_type == 'sign_out' %}signout-row{% else %}return-row{% endif %}">
            <div class="history-date">{{ record.txn.transaction_date.strftime('%Y-%m-%d %H:%M') if record.txn.transaction_date else 'N/A' }}</div>
            <div class="history-item">
              <strong>{{ record.item_name }}</strong>
              <span class="cat-badge">{{ record.category }}</span>
            </div>
            <div class="history-type">
              {% if record.txn.transaction_type == 'sign_out' %}
                <span class="type-badge signout">üì§ Sign Out</span>
              {% else %}
                <span class="type-badge return">üì• Return</span>
              {% endif %}
            </div>
            <div class="history-qty">{{ record.txn.quantity }}</div>
            <div class="history-person">{{ record.txn.person_name }}</div>
            <div class="history-details">
              {% if record.txn.transaction_type == 'sign_out' %}
                {% if record.txn.barcode %}
                  <span class="detail-tag">üè∑Ô∏è {{ record.txn.barcode }}</span>
                {% endif %}
                {% if record.txn.purpose %}
                  <span class="detail-text">{{ record.txn.purpose }}</span>
                {% endif %}
                {% if record.txn.expected_return_date %}
                  <span class="detail-tag return-due">Due: {{ record.txn.expected_return_date }}</span>
                {% endif %}
              {% else %}
                {% if record.txn.condition_notes %}
                  <span class="detail-text">{{ record.txn.condition_notes }}</span>
                {% endif %}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
      {% if all_transactions|length > 50 %}
        <p class="muted" style="text-align:center; margin-top:16px;">Showing latest 50 of {{ all_transactions|length }} transactions</p>
      {% endif %}
    {% else %}
      <div class="empty-state">
        <p>No sign-outs or returns recorded yet.</p>
      </div>
    {% endif %}
  </section>
</div>

<style>
.promo-container { display:flex; flex-direction:column; gap:20px; }
.promo-header { display:flex; flex-wrap:wrap; justify-content:space-between; gap:16px; align-items:center; }
.promo-stats { display:flex; gap:12px; flex-wrap:wrap; }
.stat-card { min-width:120px; padding:12px 16px; border-radius:12px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); }
.stat-label { font-size:0.85rem; color:rgba(255,255,255,0.6); }
.stat-value { font-size:1.5rem; font-weight:700; color:#fff; }
.promo-grid { display:grid; grid-template-columns:320px 1fr; gap:20px; }
.card { padding:20px; border-radius:16px; background:rgba(15,23,42,0.8); border:1px solid rgba(255,255,255,0.08); }
.promo-form form { display:flex; flex-direction:column; gap:12px; }
.promo-form input, .promo-form textarea, .promo-form select { width:100%; border-radius:10px; border:1px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.05); color:#fff; padding:8px 10px; }
.promo-form textarea { resize:vertical; }
.split { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px; }
.promo-list { overflow:hidden; }
.promo-table { display:flex; flex-direction:column; gap:16px; }
.category-block { border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:12px; background:rgba(0,0,0,0.15); }
.category-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.item-row { border-top:1px solid rgba(255,255,255,0.08); padding-top:12px; margin-top:12px; display:grid; gap:14px; grid-template-columns:1.2fr 1fr; }
.item-row:first-of-type { border-top:none; margin-top:0; padding-top:0; }
.item-meta { display:flex; gap:10px; flex-wrap:wrap; font-size:0.9rem; color:rgba(255,255,255,0.7); }
.status-tag { padding:2px 8px; border-radius:999px; font-size:0.75rem; text-transform:uppercase; }
.status-tag.available { background:rgba(34,197,94,0.2); color:#22c55e; }
.status-tag.signed-out { background:rgba(244,114,182,0.15); color:#f472b6; }
.return-tag { color:#fbbf24; }
.location-tag { background:rgba(59,130,246,0.2); color:#60a5fa; padding:2px 8px; border-radius:999px; font-size:0.75rem; margin-left:6px; }
.item-buttons { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
.item-actions { display:flex; flex-direction:column; gap:8px; }
.promo-action[hidden]{ display:none; }
.promo-action form { display:flex; flex-direction:column; gap:8px; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); background:rgba(15,23,42,0.4); }
.item-actions input, .item-actions textarea { width:100%; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.03); color:#fff; padding:6px 8px; }
.item-actions input:disabled, .item-actions textarea:disabled { opacity:0.5; cursor:not-allowed; }
.item-actions button { width:100%; cursor:pointer !important; pointer-events:auto !important; }
.item-actions button:disabled { opacity:0.5; cursor:not-allowed !important; }
.inline-delete { margin:0; }
.inline-delete button { width:auto; }
.btn.danger { background:linear-gradient(135deg,#ef4444,#b91c1c); color:#fff; }
.empty-state { text-align:center; padding:40px 10px; color:rgba(255,255,255,0.6); }
.history-section { margin-top:20px; }
.history-table { display:flex; flex-direction:column; gap:1px; background:rgba(255,255,255,0.05); border-radius:12px; overflow:hidden; }
.history-header { display:grid; grid-template-columns:140px 1.5fr 120px 60px 140px 2fr; gap:12px; padding:12px 16px; background:rgba(255,255,255,0.08); font-weight:600; font-size:0.85rem; color:rgba(255,255,255,0.8); text-transform:uppercase; }
.history-row { display:grid; grid-template-columns:140px 1.5fr 120px 60px 140px 2fr; gap:12px; padding:12px 16px; background:rgba(15,23,42,0.6); font-size:0.9rem; transition:background 0.2s; }
.history-row:hover { background:rgba(255,255,255,0.05); }
.signout-row { border-left:3px solid rgba(244,114,182,0.4); }
.return-row { border-left:3px solid rgba(34,197,94,0.4); }
.history-date { color:rgba(255,255,255,0.7); font-family:monospace; font-size:0.85rem; }
.history-item { display:flex; flex-direction:column; gap:4px; }
.cat-badge { font-size:0.7rem; color:rgba(255,255,255,0.5); text-transform:uppercase; }
.history-type { }
.type-badge { padding:4px 8px; border-radius:6px; font-size:0.8rem; font-weight:500; display:inline-block; }
.type-badge.signout { background:rgba(244,114,182,0.15); color:#f472b6; }
.type-badge.return { background:rgba(34,197,94,0.15); color:#22c55e; }
.history-qty { font-weight:600; color:#fff; }
.history-person { color:rgba(255,255,255,0.9); }
.history-details { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
.detail-tag { background:rgba(59,130,246,0.15); color:#60a5fa; padding:2px 8px; border-radius:6px; font-size:0.75rem; white-space:nowrap; }
.detail-tag.return-due { background:rgba(251,191,36,0.15); color:#fbbf24; }
.detail-text { color:rgba(255,255,255,0.7); font-size:0.85rem; }
@media (max-width: 1100px) {
  .promo-grid { grid-template-columns:1fr; }
  .item-row { grid-template-columns:1fr; }
  .history-header, .history-row { grid-template-columns:1fr; gap:8px; }
  .history-header { display:none; }
  .history-row > div:before { content:attr(data-label); font-weight:600; margin-right:8px; color:rgba(255,255,255,0.6); }
}
</style>
<script>
function togglePromoForm(id, type){
  const out = document.getElementById(`promo-signout-${id}`);
  const ret = document.getElementById(`promo-return-${id}`);
  if(!out || !ret) return;
  if(type === 'signout'){
    out.hidden = !out.hidden;
    if(!out.hidden) ret.hidden = true;
  }else{
    ret.hidden = !ret.hidden;
    if(!ret.hidden) out.hidden = true;
  }
}
</script>
{% endblock %}

