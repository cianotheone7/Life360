{% extends "base.html" %}

{% block title %}Orders Management - Life360 Dashboard{% endblock %}

{% block content %}
<!-- Loading Spinner -->
<div id="loading-spinner" style="width: 100%; min-height: 100vh; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 20px; position: fixed; top: 0; left: 0; z-index: 9999;">
    <div style="width: 50px; height: 50px; border: 4px solid rgba(139, 92, 246, 0.3); border-top: 4px solid #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <p style="color: rgba(255, 255, 255, 0.8); font-size: 1rem; font-weight: 500;">Loading orders...</p>
</div>

<div class="orders-container" style="opacity: 0; transition: opacity 0.5s ease;" id="orders-content">
    <!-- Header -->
    <div class="orders-header">
        <div class="orders-header-content">
            <h1 class="orders-title">
                <span class="orders-icon">üìã</span>
                Orders Management
            </h1>
            <p class="orders-subtitle">Track orders, manage workflow, and monitor completion status</p>
        </div>
        <div class="orders-actions">
            <a href="{{ url_for('new_order_form') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create New Order
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="orders-stats">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <div class="stat-number">{{ pending_orders_count if pending_orders_count is defined else 0 }}</div>
                    <div class="stat-label">Pending Orders</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-number">{{ completed_orders_count if completed_orders_count is defined else 0 }}</div>
                    <div class="stat-label">Completed Orders</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-content">
                    <div class="stat-number">{{ assigned_units_count if assigned_units_count is defined else 0 }}</div>
                    <div class="stat-label">Assigned Units</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-content">
                    <div class="stat-number">{{ required_units_count if required_units_count is defined else 0 }}</div>
                    <div class="stat-label">Required Units</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Tabs -->
    <div class="orders-tabs">
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="pending" onclick="switchTab('pending')">
                <i class="fas fa-clock"></i> Pending Orders
                <span class="tab-count">{{ pending_orders_count if pending_orders_count is defined else 0 }}</span>
            </button>
            <button class="tab-btn" data-tab="completed" onclick="switchTab('completed')">
                <i class="fas fa-check-circle"></i> Completed Orders
                <span class="tab-count">{{ completed_orders_count if completed_orders_count is defined else 0 }}</span>
            </button>
        </div>

        <!-- Pending Orders Tab -->
        <div class="tab-content active" id="pending-tab">
            {% if buckets and buckets.pending %}
                {% for provider, orders in buckets.pending.items() %}
                    <div class="provider-section">
                        <div class="provider-header">
                            <div class="provider-info">
                                <h3 class="provider-name">{{ provider }}</h3>
                                <span class="provider-count">{{ orders|length }} orders</span>
                            </div>
                        </div>
                        
                        <div class="orders-grid">
                            {% for order in orders %}
                                <div class="order-card {{ 'woocommerce-order' if order.is_woocommerce else '' }}" data-order-id="{{ order.id }}">
                                    <div class="order-header">
                                        <div class="order-info">
                                            <h4 class="order-name">
                                                {% if order.is_woocommerce %}
                                                    <span class="woocommerce-badge">üõçÔ∏è WC</span>
                                                    {{ order.customer_name or (order.name + ' ' + order.surname) }}
                                                {% else %}
                                                    {{ order.name }} {{ order.surname }}
                                                {% endif %}
                                            </h4>
                                            <p class="order-date">
                                                {% if order.is_woocommerce and order.order_date %}
                                                    {{ order.order_date.replace('T', ' ') }}
                                                {% else %}
                                                    {{ order.ordered_at.replace('T', ' ') if order.ordered_at else '' }}
                                                {% endif %}
                                            </p>
                                        </div>
                                        <div class="order-status">
                                            <span class="status-badge status-{{ order.status.lower() if order.status else 'pending' }}">{{ order.status if order.status else 'Pending' }}</span>
                                            {% if order.opt_in_status == 'Opted In' %}
                                                <span class="opt-status-badge opt-opted-in">‚úì Opted In</span>
                                            {% elif order.opt_in_status == 'Opted Out' %}
                                                <span class="opt-status-badge opt-opted-out">‚úó Opted Out</span>
                                            {% endif %}
    </div>
  </div>

                                    <div class="order-details">
                                        {% if order.is_woocommerce %}
                                            <!-- WooCommerce Order Details -->
                                            <div class="detail-row">
                                                <span class="detail-label">WooCommerce ID:</span>
                                                <span class="detail-value">#{{ order.woocommerce_id }}</span>
                                            </div>
                                            {% if order.customer_email %}
                                            <div class="detail-row">
                                                <span class="detail-label">Email:</span>
                                                <span class="detail-value">{{ order.customer_email }}</span>
                                            </div>
                                            {% endif %}
                                            {% if order.total_amount %}
                                            <div class="detail-row">
                                                <span class="detail-label">Total:</span>
                                                <span class="detail-value">R{{ "%.2f"|format(order.total_amount) }}</span>
                                            </div>
                                            {% endif %}
                                            {% if order.items_description %}
                                            <div class="detail-row">
                                                <span class="detail-label">Items:</span>
                                                <span class="detail-value">{{ order.items_description }}</span>
                                            </div>
                                            {% endif %}
                                        {% else %}
                                            <!-- Regular Order Details -->
                                            <div class="detail-row">
                                                <span class="detail-label">Assigned/Required:</span>
                                                <span class="detail-value">{{ assigned.get(order.id, 0) }} / {{ required.get(order.id, 0) }}</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Time Left:</span>
                                                <span class="countdown" id="cd-{{ order.id }}-pending" data-seconds-left="86400" data-complete="{{ 1 if order.sent_out else 0 }}">24:00:00</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="order-actions">
                                        <button class="btn btn-secondary btn-sm" onclick="openSMS('', '{{ order.name }} {{ order.surname }}')">
                                            <i class="fas fa-sms"></i> SMS
                                        </button>
                                        <button class="btn btn-courier btn-sm" onclick="openCourierProviderModal('{{ order.id }}', 'order')">
                                            <i class="fas fa-truck"></i> Book Courier
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="openOrderModal('{{ order.id }}')">
                                            <i class="fas fa-eye"></i> View Details
                                        </button>
                                    </div>
                                    
                                    <!-- Order Details Panel -->
                                    <div class="order-details-panel" id="details-{{ order.id }}-pending" style="display: none;">
                                        <div class="details-content">
                                            <div class="details-section">
                                                <h5>Assign Barcodes</h5>
                                                <form class="barcode-form" method="post" action="{{ url_for('assign_unit', order_id=order.id) }}">
                                                    <div class="form-group">
                                                        <input type="text" name="barcode" placeholder="Scan or enter barcode..." autofocus>
                                                        <button class="btn btn-primary" type="submit">Assign</button>
                                                    </div>
                        </form>
                                                
                                                <div class="assigned-units">
                                                    <h6>Assigned Units</h6>
                                                    {% for ou in (assigned_units.get(order.id, []) if assigned_units is mapping else (assigned_units | selectattr('order_id','equalto', order.id) | list)) %}
                                                        <div class="unit-item">
                                                            <span class="unit-barcode">{{ ou.unit.barcode }}</span>
                                                            <span class="unit-status">{{ ou.unit.status }}</span>
                                                            <form method="post" action="{{ url_for('unassign_unit', order_id=order.id, ou_id=ou.id) }}" style="display:inline">
                                                                <button class="btn btn-sm btn-secondary" type="submit">Unassign</button>
                              </form>
                                                        </div>
                          {% else %}
                                                        <p class="no-units">No barcodes assigned yet.</p>
                          {% endfor %}
                      </div>
                          </div>
                                            
                                            <div class="details-section">
                                                <h5>Workflow</h5>
                                                <form method="post" action="{{ url_for('update_order', order_id=order.id) }}" class="workflow-form">
                                                    <div class="workflow-checks">
                                                        <label class="check-item">
                                                            <input type="checkbox" name="sent_out" {% if order.sent_out %}checked{% endif %}>
                                                            <span class="check-label">Sent out</span>
                                                        </label>
                                                        <label class="check-item">
                                                            <input type="checkbox" name="received_back" {% if order.received_back %}checked{% endif %}>
                                                            <span class="check-label">Received Back</span>
                                                        </label>
                                                        <label class="check-item">
                                                            <input type="checkbox" name="kit_registered" {% if order.kit_registered %}checked{% endif %}>
                                                            <span class="check-label">Kit Registered</span>
                                                        </label>
                                                        <label class="check-item">
                                                            <input type="checkbox" name="results_sent" {% if order.results_sent %}checked{% endif %}>
                                                            <span class="check-label">Results Sent</span>
                                                        </label>
                                                        <label class="check-item">
                                                            <input type="checkbox" name="paid" {% if order.paid %}checked{% endif %}>
                                                            <span class="check-label">Paid</span>
                                                        </label>
                                                        <label class="check-item">
                                                            <input type="checkbox" name="invoiced" {% if order.invoiced %}checked{% endif %}>
                                                            <span class="check-label">Invoiced</span>
                                                        </label>
                                                    </div>
                                                    
                                                    <div class="form-row">
                                                        <div class="form-group">
                                                            <label>Practitioner Name</label>
                                                            <input type="text" name="practitioner_name" value="{{ order.practitioner_name }}">
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Status</label>
                              <select name="status">
                                                                <option value="Pending" {% if order.status=='Pending' %}selected{% endif %}>Pending</option>
                                                                <option value="Completed" {% if order.status=='Completed' %}selected{% endif %}>Completed</option>
                              </select>
                          </div>
                                                        <div class="form-group">
                                                            <label>Opt-In Status</label>
                                                            <select name="opt_in_status">
                                                                <option value="Opted In" {% if order.opt_in_status=='Opted In' %}selected{% endif %}>Opted In</option>
                                                                <option value="Opted Out" {% if order.opt_in_status=='Opted Out' %}selected{% endif %}>Opted Out</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="form-group">
                            <label>Notes</label>
                                                        <textarea name="notes" rows="3">{{ order.notes }}</textarea>
                          </div>
                                                    
                                                    <div class="form-actions">
                                                        <button class="btn btn-primary" type="submit">Save Changes</button>
                                                        <button class="btn btn-secondary" type="button" onclick="openSMS('', '{{ order.name }} {{ order.surname }}')">Send SMS</button>
                          </div>
                        </form>

                                                <div class="call-logs">
                                                    <h6>Call Logs</h6>
                                                    {% for c in (call_logs.get(order.id, []) if call_logs is mapping else (call_logs | selectattr('order_id','equalto', order.id) | list)) %}
                                                        <div class="log-item">
                                                            <div class="log-header">
                                                                <span class="log-author">{{ c.author or 'Staff' }}</span>
                                                                <span class="log-date">{{ c.when }}</span>
                                                            </div>
                                                            <div class="log-outcome">{{ c.outcome or '‚Äî' }}</div>
                                                            <div class="log-summary">{{ c.summary }}</div>
                                                        </div>
                          {% else %}
                                                        <p class="no-logs">No call logs yet.</p>
                          {% endfor %}
                                                    
                                                    <form class="log-form" method="post" action="{{ url_for('add_calllog', order_id=order.id) }}">
                                                        <div class="form-row">
                                                            <div class="form-group">
                                                                <label>Author</label>
                                                                <input name="author" placeholder="Your name">
                                                            </div>
                                                            <div class="form-group">
                                                                <label>Outcome</label>
                            <select name="outcome">
                              <option value="">‚Äî</option>
                                                                    <option>Spoke</option>
                                                                    <option>No Answer</option>
                                                                    <option>Left VM</option>
                                                                    <option>Emailed</option>
                                                                    <option>Escalated</option>
                            </select>
                      </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Summary</label>
                                                            <textarea name="summary" rows="3"></textarea>
                                                        </div>
                                                        <button class="btn btn-primary btn-sm" type="submit">Add Call Log</button>
                                                    </form>
                    </div>

                                                <div class="order-items">
                                                    <h6>Order Items</h6>
                                                    {% for it in (order['items'] | default([])) %}
                                                        <div class="item-row">
                                                            <span class="item-sku">{{ it.sku }}</span>
                                                            <span class="item-qty">√ó {{ it.qty }}</span>
                  </div>
              {% endfor %}
                                                </div>
                                                
                                                <div class="danger-zone">
                                                    <form method="post" action="{{ url_for('delete_order', order_id=order.id) }}" class="delete-form">
                                                        <button class="btn btn-danger btn-sm" type="submit" onclick="return confirm('Delete this order and unassign its barcodes?')">
                                                            <i class="fas fa-trash"></i> Delete Order
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                            
                                            {% if order.raw_api_data %}
                                            <div class="details-section">
                                                <h5>Raw API Data</h5>
                                                <div class="api-data-container">
                                                    <pre class="api-data-content">{{ order.raw_api_data }}</pre>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
        </div>
      {% endfor %}
                        </div>
    </div>
    {% endfor %}
  {% else %}
                <div class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <h4>No pending orders</h4>
                    <p>All orders have been completed or no orders have been created yet.</p>
                    <a href="{{ url_for('new_order_form') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create First Order
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Completed Orders Tab -->
        <div class="tab-content" id="completed-tab">
            {% if buckets and buckets.completed %}
                {% for provider, orders in buckets.completed.items() %}
                    <div class="provider-section">
                        <div class="provider-header">
                            <div class="provider-info">
                                <h3 class="provider-name">{{ provider }}</h3>
                                <span class="provider-count">{{ orders|length }} orders</span>
                      </div>
                          </div>
                        
                        <div class="orders-grid">
                            {% for order in orders %}
                                <div class="order-card completed {{ 'woocommerce-order' if order.is_woocommerce else '' }}" data-order-id="{{ order.id }}">
                                    <div class="order-header">
                                        <div class="order-info">
                                            <h4 class="order-name">
                                                {% if order.is_woocommerce %}
                                                    <span class="woocommerce-badge">üõçÔ∏è WC</span>
                                                    {{ order.customer_name or (order.name + ' ' + order.surname) }}
                                                {% else %}
                                                    {{ order.name }} {{ order.surname }}
                                                {% endif %}
                                            </h4>
                                            <p class="order-date">
                                                {% if order.is_woocommerce and order.order_date %}
                                                    {{ order.order_date.replace('T', ' ') }}
                                                {% else %}
                                                    {{ order.ordered_at.replace('T', ' ') if order.ordered_at else '' }}
                                                {% endif %}
                                            </p>
                          </div>
                                        <div class="order-status">
                                            <span class="status-badge status-completed">{{ order.status }}</span>
                                            {% if order.opt_in_status == 'Opted In' %}
                                                <span class="opt-status-badge opt-opted-in">‚úì Opted In</span>
                                            {% elif order.opt_in_status == 'Opted Out' %}
                                                <span class="opt-status-badge opt-opted-out">‚úó Opted Out</span>
                                            {% endif %}
                          </div>
                          </div>
                                    
                                    <div class="order-details">
                                        {% if order.is_woocommerce %}
                                            <!-- WooCommerce Order Details -->
                                            <div class="detail-row">
                                                <span class="detail-label">WooCommerce ID:</span>
                                                <span class="detail-value">#{{ order.woocommerce_id }}</span>
                                            </div>
                                            {% if order.customer_email %}
                                            <div class="detail-row">
                                                <span class="detail-label">Email:</span>
                                                <span class="detail-value">{{ order.customer_email }}</span>
                                            </div>
                                            {% endif %}
                                            {% if order.total_amount %}
                                            <div class="detail-row">
                                                <span class="detail-label">Total:</span>
                                                <span class="detail-value">R{{ "%.2f"|format(order.total_amount) }}</span>
                                            </div>
                                            {% endif %}
                                            {% if order.items_description %}
                                            <div class="detail-row">
                                                <span class="detail-label">Items:</span>
                                                <span class="detail-value">{{ order.items_description }}</span>
                                            </div>
                                            {% endif %}
                                            <div class="detail-row">
                                                <span class="detail-label">Status:</span>
                                                <span class="detail-value completed">‚úì {{ order.status }}</span>
                                            </div>
                                        {% else %}
                                            <!-- Regular Order Details -->
                                            <div class="detail-row">
                                                <span class="detail-label">Assigned/Required:</span>
                                                <span class="detail-value">{{ assigned.get(order.id, 0) }} / {{ required.get(order.id, 0) }}</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Completed:</span>
                                                <span class="detail-value completed">‚úì Completed</span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="order-actions">
                                        <button class="btn btn-secondary btn-sm" onclick="openSMS('', '{{ order.name }} {{ order.surname }}')">
                                            <i class="fas fa-sms"></i> SMS
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="openOrderModal('{{ order.id }}')">
                                            <i class="fas fa-eye"></i> View Details
                                        </button>
                  </div>
                                    
                                    <!-- Order Details Panel -->
                                    <div class="order-details-panel" id="details-{{ order.id }}-completed" style="display: none;">
                                        <div class="details-content">
                                            <div class="details-section">
                                                <h5>Order Summary</h5>
                                                <p>This order has been completed. All workflow steps have been finished.</p>
                                            </div>
                                            
                                            {% if order.raw_api_data %}
                                            <div class="details-section">
                                                <h5>Raw API Data</h5>
                                                <div class="api-data-container">
                                                    <pre class="api-data-content">{{ order.raw_api_data }}</pre>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
              {% endfor %}
        </div>
                    </div>
      {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">‚úÖ</div>
                    <h4>No completed orders</h4>
                    <p>Complete some orders to see them listed here.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Courier Provider Selection Modal -->
<div id="courierProviderModal" class="modal-overlay" style="display: none;">
    <div class="modal-container provider-modal">
        <div class="modal-header">
            <h2 class="modal-title">
                <span class="modal-icon">üöö</span>
                Select Courier Provider
            </h2>
            <button class="modal-close" onclick="closeCourierProviderModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-content">
            <div class="provider-options">
                <div class="provider-option">
                    <input type="radio" name="courier_provider" value="courier_guy_geneway" id="provider_courier_guy_geneway" checked>
                    <label for="provider_courier_guy_geneway" class="provider-label">
                        <div class="provider-icon">üöö</div>
                        <div class="provider-info">
                            <div class="provider-name">Courier Guy (Geneway)</div>
                        </div>
                    </label>
                </div>
                
                <div class="provider-option">
                    <input type="radio" name="courier_provider" value="courier_guy_healthy_me" id="provider_courier_guy_healthy_me">
                    <label for="provider_courier_guy_healthy_me" class="provider-label">
                        <div class="provider-icon">üè•</div>
                        <div class="provider-info">
                            <div class="provider-name">Courier Guy (Healthy Me)</div>
                        </div>
                    </label>
                </div>
                
                <div class="provider-option">
                    <input type="radio" name="courier_provider" value="courier_guy_intelligene" id="provider_courier_guy_intelligene">
                    <label for="provider_courier_guy_intelligene" class="provider-label">
                        <div class="provider-icon">üß†</div>
                        <div class="provider-info">
                            <div class="provider-name">Courier Guy (Intelligene)</div>
                        </div>
                    </label>
                </div>
                
                <div class="provider-option">
                    <input type="radio" name="courier_provider" value="mds_geneway" id="provider_mds_geneway">
                    <label for="provider_mds_geneway" class="provider-label">
                        <div class="provider-icon">üì¶</div>
                        <div class="provider-info">
                            <div class="provider-name">MDS (Geneway)</div>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCourierProviderModal()">Cancel</button>
            <button class="btn btn-primary" onclick="selectCourierProvider()">Select Provider</button>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div id="orderModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">
                <span class="modal-icon">üìã</span>
                Order Details
            </h2>
            <button class="modal-close" onclick="closeOrderModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-content">
            <div class="modal-tabs">
                <button class="tab-button active" onclick="switchModalTab('workflow')">Workflow</button>
                <button class="tab-button" onclick="switchModalTab('barcodes')">Assign Barcodes</button>
                <button class="tab-button" onclick="switchModalTab('logs')">Call Logs</button>
                      </div>
            
            <!-- Workflow Tab -->
            <div id="workflow-tab" class="tab-content active">
                <div class="workflow-section">
                    <h3>Order Workflow</h3>
                    <div class="workflow-checks">
                        <label class="check-item">
                            <input type="checkbox" name="sent_out" id="modal_sent_out">
                            <span class="check-label">Sent out</span>
                        </label>
                        <label class="check-item">
                            <input type="checkbox" name="received_back" id="modal_received_back">
                            <span class="check-label">Received Back</span>
                        </label>
                        <label class="check-item">
                            <input type="checkbox" name="kit_registered" id="modal_kit_registered">
                            <span class="check-label">Kit Registered</span>
                        </label>
                        <label class="check-item">
                            <input type="checkbox" name="results_sent" id="modal_results_sent">
                            <span class="check-label">Results Sent</span>
                        </label>
                        <label class="check-item">
                            <input type="checkbox" name="paid" id="modal_paid">
                            <span class="check-label">Paid</span>
                        </label>
                        <label class="check-item">
                            <input type="checkbox" name="invoiced" id="modal_invoiced">
                            <span class="check-label">Invoiced</span>
                        </label>
                          </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Practitioner Name</label>
                            <input type="text" name="practitioner_name" id="modal_practitioner_name">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select name="status" id="modal_status">
                                <option value="Pending">Pending</option>
                                <option value="Completed">Completed</option>
                              </select>
                          </div>
                        <div class="form-group">
                            <label>Opt-In Status</label>
                            <select name="opt_in_status" id="modal_opt_in_status">
                                <option value="">Pending</option>
                                <option value="Opted In">Opted In</option>
                                <option value="Opted Out">Opted Out</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                            <label>Notes</label>
                        <textarea name="notes" id="modal_notes" rows="4"></textarea>
                          </div>
                          </div>
            </div>
            
            <!-- Barcodes Tab -->
            <div id="barcodes-tab" class="tab-content">
                <div class="barcodes-section">
                    <h3>Assign Barcodes</h3>
                    <div class="barcode-input">
                        <input type="text" id="modal_barcode_input" placeholder="Enter barcode">
                        <button class="btn btn-primary" onclick="assignBarcode()">Assign</button>
                    </div>
                    <div class="assigned-units">
                        <h4>Assigned Units</h4>
                        <div id="modal_assigned_units" class="units-list">
                            <p class="empty-state">No barcodes assigned yet.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Call Logs Tab -->
            <div id="logs-tab" class="tab-content">
                <div class="logs-section">
                    <h3>Call Logs</h3>
                    <div id="modal_call_logs" class="call-logs-list">
                        <p class="empty-state">No call logs yet.</p>
                    </div>
                    
                    <div class="add-log-form">
                        <h4>Add Call Log</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Author</label>
                                <input type="text" name="author" id="modal_log_author" placeholder="Your name">
                            </div>
                            <div class="form-group">
                                <label>Outcome</label>
                                <select name="outcome" id="modal_log_outcome">
                                    <option value="-">-</option>
                                    <option value="Success">Success</option>
                                    <option value="Failed">Failed</option>
                                    <option value="Follow-up">Follow-up</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Summary</label>
                            <textarea name="summary" id="modal_log_summary" rows="3" placeholder="Call summary..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="addCallLog()">Add Call Log</button>
                    </div>
                </div>
                      </div>
                    </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeOrderModal()">Close</button>
            <button class="btn btn-primary" onclick="saveOrderChanges()">Save Changes</button>
                  </div>
        </div>
    </div>

<style>
/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
}

.modal-container {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 16px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.05);
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #fff;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.modal-icon {
    font-size: 1.2rem;
}

.modal-close {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
}

.modal-content {
    padding: 24px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.tab-button {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    padding: 12px 20px;
    cursor: pointer;
    border-radius: 8px 8px 0 0;
    transition: all 0.2s ease;
    font-weight: 500;
}

.tab-button.active {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
    border-bottom: 2px solid #3b82f6;
}

.tab-button:hover:not(.active) {
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px 24px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.02);
}

.barcode-input {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
}

.barcode-input input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
    font-size: 0.95rem;
}

.units-list {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    padding: 16px;
    min-height: 100px;
}

.call-logs-list {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
    min-height: 120px;
}

.empty-state {
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
    text-align: center;
    margin: 20px 0;
}

.add-log-form {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    padding: 20px;
}

.barcode-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    margin-bottom: 8px;
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
}

.barcode-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.barcode-code {
    color: #fff;
    font-family: monospace;
    font-weight: 500;
}

.barcode-status {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.barcode-info {
    width: 100%;
}

.barcode-item-name {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
}

.call-log-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    border-left: 3px solid #3b82f6;
}

.log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.log-author {
    color: #fff;
    font-weight: 600;
}

.log-outcome {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.log-outcome.success {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.log-outcome.failed {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.log-outcome.follow-up {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.log-time {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.8rem;
}

.log-summary {
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.4;
}

/* Orders Page Styles */
.orders-container {
    width: 100%;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}

/* Header Styles */
.orders-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding: 20px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.orders-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #fff;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.orders-icon {
    font-size: 2.2rem;
    filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
}

.orders-subtitle {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.1rem;
    margin: 8px 0 0 0;
    font-weight: 400;
}

.orders-actions {
    display: flex;
    gap: 12px;
}

/* Stats Section */
.orders-stats {
    margin-bottom: 30px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: 1.8rem;
    font-weight: 700;
    color: #fff;
    line-height: 1;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
}

/* Tabs */
.orders-tabs {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.tab-navigation {
    display: flex;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.tab-btn {
    flex: 1;
    padding: 20px 24px;
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    position: relative;
}

.tab-btn:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.05);
}

.tab-btn.active {
    color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
}

.tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #3b82f6, #1d4ed8);
}

.tab-count {
    background: rgba(255, 255, 255, 0.1);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.tab-btn.active .tab-count {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

.tab-content {
    display: none;
    padding: 24px;
}

.tab-content.active {
    display: block;
}

/* Provider Sections */
.provider-section {
    margin-bottom: 30px;
}

.provider-header {
    padding: 20px 24px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px 16px 0 0;
}

.provider-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.provider-name {
    font-size: 1.3rem;
    font-weight: 600;
    color: #fff;
    margin: 0;
}

.provider-count {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    border: 1px solid rgba(59, 130, 246, 0.3);
}

/* Orders Grid */
.orders-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 20px;
    padding: 24px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
    border-radius: 0 0 16px 16px;
}

/* Order Cards */
.order-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 20px;
    transition: all 0.3s ease;
    position: relative;
}

.order-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.order-card.completed {
    border-color: rgba(16, 185, 129, 0.3);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.02));
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.order-info h4 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
    margin: 0 0 4px 0;
}

.order-date {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
    margin: 0;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    margin-right: 6px;
}

.opt-status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
}

.opt-status-badge.opt-opted-in {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.opt-status-badge.opt-pending {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.status-pending {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.status-completed {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.order-details {
    margin-bottom: 16px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.detail-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
}

.detail-value {
    color: #fff;
    font-weight: 600;
    font-size: 0.9rem;
}

.detail-value.completed {
    color: #10b981;
}

.countdown {
    background: rgba(255, 255, 255, 0.1);
    padding: 4px 8px;
    border-radius: 8px;
    font-family: monospace;
    font-weight: 600;
}

.order-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

/* Button Styles */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

.btn-secondary {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
    transform: translateY(-1px);
}

.btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
}

.btn-sm {
    padding: 8px 12px;
    font-size: 0.85rem;
}

.btn-courier {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    text-decoration: none;
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
}

.btn-courier:hover {
    background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
    color: white;
    text-decoration: none;
}

/* Order Details Panel */
.order-details-panel {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.details-content {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Balanced columns */
    gap: 24px; /* Reduced gap for better balance */
    min-height: 0; /* Prevent grid overflow */
    align-items: start; /* Align sections to top */
}

.details-section {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px; /* Reduced padding */
    min-height: 300px; /* Reduced minimum height */
}

.details-section h5 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
    margin: 0 0 16px 0;
}

.details-section h6 {
    font-size: 1rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
    margin: 16px 0 12px 0;
}

/* Raw API Data Styling */
.api-data-container {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 16px;
    max-height: 400px;
    overflow-y: auto;
}

.api-data-content {
    color: #e0e0e0;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.4;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Form Styles */
.barcode-form {
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.form-group input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
    font-size: 0.95rem;
}

.form-group input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px; /* Increased gap */
    margin-bottom: 20px; /* Increased margin */
}

.form-row .form-group {
    display: flex;
    flex-direction: column;
    gap: 10px; /* Increased gap */
}

.form-row label {
    font-size: 0.9rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
}

.form-row input,
.form-row select,
.form-row textarea {
    padding: 12px 16px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
    font-size: 0.95rem;
}

.form-row textarea {
    resize: vertical;
    min-height: 80px; /* Reduced height */
    max-height: 150px; /* Reduced maximum height */
}

.form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
}

/* Workflow Checks */
.workflow-checks {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px; /* Increased gap */
    margin-bottom: 24px; /* Increased margin */
}

.check-item {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.check-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #3b82f6;
}

.check-label {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.9rem;
    font-weight: 500;
}

/* Assigned Units */
.assigned-units {
    margin-top: 16px;
}

.unit-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin-bottom: 8px;
}

.unit-barcode {
    font-family: monospace;
    font-weight: 600;
    color: #3b82f6;
}

.unit-status {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
}

.no-units {
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
    margin: 0;
}

/* Call Logs */
.call-logs {
    margin-top: 20px;
}

.log-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
}

.log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.log-author {
    font-weight: 600;
    color: #fff;
}

.log-date {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
}

.log-outcome {
    color: #3b82f6;
    font-weight: 600;
    margin-bottom: 4px;
}

.log-summary {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
}

.no-logs {
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
    margin: 0;
}

.log-form {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* Order Items */
.order-items {
    margin-top: 20px;
}

.item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.item-sku {
    font-weight: 600;
    color: #fff;
}

.item-qty {
    color: rgba(255, 255, 255, 0.7);
}

/* Danger Zone */
.danger-zone {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(239, 68, 68, 0.2);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255, 255, 255, 0.7);
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state h4 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #fff;
    margin: 0 0 12px 0;
}

.empty-state p {
    font-size: 1rem;
    margin: 0 0 24px 0;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

.modal-overlay.active {
    display: flex;
}

.modal-container {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 0;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
}

.modal-header {
    padding: 25px 30px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    color: white;
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-icon {
    font-size: 1.8rem;
}

.modal-close {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.modal-close:hover {
    color: white;
    background: rgba(255, 255, 255, 0.1);
}

.modal-content {
    padding: 30px;
}

.modal-footer {
    padding: 20px 30px 25px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

.provider-modal {
    max-width: 500px;
}

.provider-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.provider-option {
    position: relative;
}

.provider-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.provider-label {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.provider-option input[type="radio"]:checked + .provider-label {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
}

.provider-icon {
    font-size: 2rem;
}

.provider-name {
    color: white;
    font-weight: 500;
    font-size: 1.1rem;
}

/* WooCommerce Order Styling */
.woocommerce-order {
    border-left: 4px solid #7c3aed !important;
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(124, 58, 237, 0.02)) !important;
}

.woocommerce-badge {
    background: linear-gradient(135deg, #7c3aed, #5b21b6);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 8px;
    display: inline-block;
}

.woocommerce-order .order-header {
    border-bottom: 1px solid rgba(124, 58, 237, 0.1);
}

.woocommerce-order .detail-value {
    color: rgba(255, 255, 255, 0.95);
}

.woocommerce-order:hover {
    border-left-color: #8b5cf6;
    box-shadow: 0 8px 25px rgba(124, 58, 237, 0.15);
}

/* Responsive Design */
@media (max-width: 768px) {
    .orders-container {
        padding: 16px;
    }
    
    .orders-header {
        flex-direction: column;
        gap: 20px;
        align-items: flex-start;
    }
    
    .orders-title {
        font-size: 2rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .tab-navigation {
        flex-direction: column;
    }
    
    .orders-grid {
        grid-template-columns: 1fr;
    }
    
    .details-content {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .details-section {
        padding: 20px;
        min-height: auto; /* Remove fixed height on mobile */
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 16px; /* Maintain good spacing on mobile */
    }
    
    .workflow-checks {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
}
</style>

<script>
// Modal functionality
let currentOrderId = null;

function openOrderModal(orderId) {
    currentOrderId = orderId;
    const modal = document.getElementById('orderModal');
    modal.style.display = 'flex';
    
    // Reset to workflow tab
    switchModalTab('workflow');
    
    // Load order data
    loadOrderData(orderId);
}

function closeOrderModal() {
    const modal = document.getElementById('orderModal');
    modal.style.display = 'none';
    currentOrderId = null;
}

function switchModalTab(tabName) {
    const modal = document.getElementById('orderModal');
    if (!modal) return;
    
    // Hide all modal tabs
    modal.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all modal tab buttons
    modal.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(`${tabName}-tab`);
    if (selectedTab) {
        selectedTab.classList.add('active');
    }
    
    // Add active class to clicked button
    const clickedButton = modal.querySelector(`[onclick="switchModalTab('${tabName}')"]`);
    if (clickedButton) {
        clickedButton.classList.add('active');
    }
}

function loadOrderData(orderId) {
    // Fetch order data from server
    fetch(`/orders/${orderId}/json`)
        .then(response => response.json())
        .then(data => {
            // Populate form fields
            document.getElementById('modal_practitioner_name').value = data.practitioner_name || '';
            document.getElementById('modal_status').value = data.status || 'Pending';
            document.getElementById('modal_opt_in_status').value = data.opt_in_status || '';
            document.getElementById('modal_notes').value = data.notes || '';
            document.getElementById('modal_sent_out').checked = data.sent_out || false;
            document.getElementById('modal_received_back').checked = data.received_back || false;
            document.getElementById('modal_kit_registered').checked = data.kit_registered || false;
            document.getElementById('modal_results_sent').checked = data.results_sent || false;
            document.getElementById('modal_paid').checked = data.paid || false;
            document.getElementById('modal_invoiced').checked = data.invoiced || false;
            
            // Populate assigned barcodes
            const unitsList = document.getElementById('modal_assigned_units');
            if (data.assigned_units && data.assigned_units.length > 0) {
                unitsList.innerHTML = '';
                data.assigned_units.forEach(unit => {
                    const barcodeItem = document.createElement('div');
                    barcodeItem.className = 'barcode-item';
                    barcodeItem.innerHTML = `
                        <div class="barcode-details">
                            <span class="barcode-code">${unit.barcode}</span>
                            <span class="barcode-status">${unit.status}</span>
                        </div>
                        <div class="barcode-info">
                            <span class="barcode-item-name">${unit.item_name} (${unit.provider})</span>
                        </div>
                    `;
                    unitsList.appendChild(barcodeItem);
                });
            } else {
                unitsList.innerHTML = '<p class="empty-state">No barcodes assigned yet.</p>';
            }
        })
        .catch(error => {
            console.error('Error loading order data:', error);
        });
}

function saveOrderChanges() {
    if (!currentOrderId) return;
    
    // Collect form data
    const formData = {
        sent_out: document.getElementById('modal_sent_out').checked,
        received_back: document.getElementById('modal_received_back').checked,
        kit_registered: document.getElementById('modal_kit_registered').checked,
        results_sent: document.getElementById('modal_results_sent').checked,
        paid: document.getElementById('modal_paid').checked,
        invoiced: document.getElementById('modal_invoiced').checked,
        practitioner_name: document.getElementById('modal_practitioner_name').value,
        status: document.getElementById('modal_status').value,
        opt_in_status: document.getElementById('modal_opt_in_status').value,
        notes: document.getElementById('modal_notes').value
    };
    
    // Send to server
    fetch(`/orders/${currentOrderId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Order updated successfully!');
            closeOrderModal();
            location.reload();
        } else {
            alert('Failed to update order');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update order');
    });
}

function assignBarcode() {
    const barcodeInput = document.getElementById('modal_barcode_input');
    const barcode = barcodeInput.value.trim();
    
    if (!barcode) {
        alert('Please enter a barcode');
        return;
    }
    
    const unitsList = document.getElementById('modal_assigned_units');
    if (unitsList.querySelector('.empty-state')) {
        unitsList.innerHTML = '';
    }
    
    const barcodeItem = document.createElement('div');
    barcodeItem.className = 'barcode-item';
    barcodeItem.innerHTML = `
        <span class="barcode-code">${barcode}</span>
        <button class="btn btn-sm btn-danger" onclick="removeBarcode(this)">Remove</button>
    `;
    
    unitsList.appendChild(barcodeItem);
    barcodeInput.value = '';
}

function removeBarcode(button) {
    button.parentElement.remove();
    
    const unitsList = document.getElementById('modal_assigned_units');
    if (unitsList.children.length === 0) {
        unitsList.innerHTML = '<p class="empty-state">No barcodes assigned yet.</p>';
    }
}

function addCallLog() {
    const author = document.getElementById('modal_log_author').value.trim();
    const outcome = document.getElementById('modal_log_outcome').value;
    const summary = document.getElementById('modal_log_summary').value.trim();
    
    if (!author || !summary) {
        alert('Please fill in author and summary');
        return;
    }
    
    const logsList = document.getElementById('modal_call_logs');
    if (logsList.querySelector('.empty-state')) {
        logsList.innerHTML = '';
    }
    
    const logItem = document.createElement('div');
    logItem.className = 'call-log-item';
    logItem.innerHTML = `
        <div class="log-header">
            <span class="log-author">${author}</span>
            <span class="log-outcome ${outcome.toLowerCase()}">${outcome}</span>
            <span class="log-time">${new Date().toLocaleString()}</span>
        </div>
        <div class="log-summary">${summary}</div>
    `;
    
    logsList.appendChild(logItem);
    
    document.getElementById('modal_log_author').value = '';
    document.getElementById('modal_log_outcome').value = '-';
    document.getElementById('modal_log_summary').value = '';
}

// Tab switching functionality
function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}-tab`).classList.add('active');
}

// Order details toggle
function toggleOrderDetails(orderId, tab) {
    const panel = document.getElementById(`details-${orderId}-${tab}`);
    const btn = document.querySelector(`[onclick="toggleOrderDetails('${orderId}', '${tab}')"]`);
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Details';
    } else {
        panel.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-chevron-down"></i> Details';
    }
}

// Auto-submit workflow forms
document.addEventListener('change', function(e) {
    if (e.target.closest('.workflow-form')) {
        const form = e.target.closest('.workflow-form');
        
        // Check if all workflow flags are checked
        const flags = ['sent_out', 'received_back', 'kit_registered', 'results_sent', 'paid', 'invoiced'];
        const allChecked = flags.every(name => {
            const checkbox = form.querySelector(`input[name="${name}"]`);
            return checkbox && checkbox.checked;
        });
        
        if (allChecked) {
            const statusSelect = form.querySelector('select[name="status"]');
            if (statusSelect) {
                statusSelect.value = 'Completed';
            }
        }
        
        // Auto-submit the form
        form.submit();
    }
});

// SMS functionality (placeholder)
function openSMS(phone, name) {
    alert(`SMS functionality for ${name} would open here.`);
}

// Countdown timer functionality
function updateCountdowns() {
    document.querySelectorAll('.countdown').forEach(element => {
        if (element.dataset.complete === '1') {
            element.textContent = 'Completed';
            element.style.color = '#10b981';
            return;
        }
        
        let seconds = parseInt(element.dataset.secondsLeft || '86400', 10);
        if (seconds <= 0) {
            element.textContent = 'Expired';
            element.style.color = '#ef4444';
            return;
        }
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        element.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        element.style.color = '';
        
        element.dataset.secondsLeft = (seconds - 1).toString();
    });
}

// Initialize countdown timers
document.addEventListener('DOMContentLoaded', function() {
    // Hide loading spinner and show content
    setTimeout(function() {
        const spinner = document.getElementById('loading-spinner');
        const content = document.getElementById('orders-content');
        if (spinner) spinner.style.display = 'none';
        if (content) content.style.opacity = '1';
    }, 100);
    
    updateCountdowns();
    setInterval(updateCountdowns, 1000);
    
    // Check URL for tab parameter
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');
    if (tab && (tab === 'pending' || tab === 'completed')) {
        switchTab(tab);
    }
});

// Courier Provider Modal Functions
function openCourierProviderModal(id, context) {
    const modal = document.getElementById('courierProviderModal');
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('active');
        }, 10);
        
        // Store the context for later use
        modal.dataset.context = context;
        modal.dataset.id = id;
    }
}

function closeCourierProviderModal() {
    const modal = document.getElementById('courierProviderModal');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
}

function selectCourierProvider() {
    const modal = document.getElementById('courierProviderModal');
    const selectedProvider = document.querySelector('input[name="courier_provider"]:checked');
    
    if (selectedProvider && modal) {
        const context = modal.dataset.context;
        const id = modal.dataset.id;
        
        // Redirect to courier booking page with selected provider
        let url;
        if (context === 'order') {
            url = `/orders/${id}/book-courier?provider=${selectedProvider.value}`;
        } else {
            url = `/practitioners/${id}/book-courier?provider=${selectedProvider.value}`;
        }
        
        window.location.href = url;
    }
}
</script>
{% endblock %}
